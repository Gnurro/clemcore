<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
<meta name="generator" content="pdoc3 0.11.6">
<title>clemcore.backends.utils API documentation</title>
<meta name="description" content="">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/sanitize.min.css" integrity="sha512-y1dtMcuvtTMJc1yPgEqF0ZjQbhnc/bFhyvIyVNb9Zk5mIGtqVaAB1Ttl28su8AvFMOY0EwRbAe+HCLqj6W7/KA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/typography.min.css" integrity="sha512-Y1DYSb995BAfxobCkKepB1BqJJTPrOp3zPL74AWFugHHmmdcvO+C48WLrUOlhGMc0QG7AE3f7gmvvcrmX2fDoA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:1.5em;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:2em 0 .50em 0}h3{font-size:1.4em;margin:1.6em 0 .7em 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .2s ease-in-out}a:visited{color:#503}a:hover{color:#b62}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900;font-weight:bold}pre code{font-size:.8em;line-height:1.4em;padding:1em;display:block}code{background:#f3f3f3;font-family:"DejaVu Sans Mono",monospace;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source > summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible;min-width:max-content}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em 1em;margin:1em 0}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul ul{padding-left:1em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ==" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => {
hljs.configure({languages: ['bash', 'css', 'diff', 'graphql', 'ini', 'javascript', 'json', 'plaintext', 'python', 'python-repl', 'rust', 'shell', 'sql', 'typescript', 'xml', 'yaml']});
hljs.highlightAll();
/* Collapse source docstrings */
setTimeout(() => {
[...document.querySelectorAll('.hljs.language-python > .hljs-string')]
.filter(el => el.innerHTML.length > 200 && ['"""', "'''"].includes(el.innerHTML.substring(0, 3)))
.forEach(el => {
let d = document.createElement('details');
d.classList.add('hljs-string');
d.innerHTML = '<summary>"""</summary>' + el.innerHTML.substring(3);
el.replaceWith(d);
});
}, 100);
})</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>clemcore.backends.utils</code></h1>
</header>
<section id="section-intro">
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="clemcore.backends.utils.check_context_limit_generic"><code class="name flex">
<span>def <span class="ident">check_context_limit_generic</span></span>(<span>context_size: int,<br>prompt_tokens: List,<br>model_name: str,<br>max_new_tokens: int = 100) ‑> Tuple[bool, int, int, int]</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def check_context_limit_generic(context_size: int, prompt_tokens: List, model_name: str, max_new_tokens: int = 100) \
        -&gt; Tuple[bool, int, int, int]:
    &#34;&#34;&#34;Internal context limit check to run in generate_response.
    Used to assure that the context limit of a model is not exceeding during benchmark runs. Allows to fail gracefully
    in case the context limit is exceeded, assuring proper record keeping.
    The potentially raised ContextExceedError is intended to be caught by game code to modify input message histories
    without impacting the game experiment.
    Args:
        context_size: The context size limit of the model.
        prompt_tokens: List of prompt token IDs.
        model_name: Name of the model checked for.
        max_new_tokens: How many tokens to generate (&#39;at most&#39;, but no stop sequence is defined).
    Returns:
        Tuple with

        - Bool: True if context limit is not exceeded, False if too many tokens
        - Number of tokens for the given messages and maximum new tokens
        - Number of tokens of &#39;context space left&#39;
        - Total context token limit
    Raises:
        ContextExceededError: A ContextExceededError exception containing context usage information is raised if the
            context limit is exceeded.
    &#34;&#34;&#34;
    prompt_size = len(prompt_tokens)
    tokens_used = prompt_size + max_new_tokens  # context includes tokens to be generated
    tokens_left = context_size - tokens_used
    fits = tokens_used &lt;= context_size

    if not fits:
        logger.info(f&#34;Context token limit for {model_name} exceeded: {tokens_used}/{tokens_left}&#34;)
        # fail gracefully:
        raise ContextExceededError(f&#34;Context token limit for {model_name} exceeded&#34;,
                                   tokens_used=tokens_used, tokens_left=tokens_left, context_size=context_size)

    return fits, tokens_used, tokens_left, context_size</code></pre>
</details>
<div class="desc"><p>Internal context limit check to run in generate_response.
Used to assure that the context limit of a model is not exceeding during benchmark runs. Allows to fail gracefully
in case the context limit is exceeded, assuring proper record keeping.
The potentially raised ContextExceedError is intended to be caught by game code to modify input message histories
without impacting the game experiment.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>context_size</code></strong></dt>
<dd>The context size limit of the model.</dd>
<dt><strong><code>prompt_tokens</code></strong></dt>
<dd>List of prompt token IDs.</dd>
<dt><strong><code>model_name</code></strong></dt>
<dd>Name of the model checked for.</dd>
<dt><strong><code>max_new_tokens</code></strong></dt>
<dd>How many tokens to generate ('at most', but no stop sequence is defined).</dd>
</dl>
<h2 id="returns">Returns</h2>
<p>Tuple with</p>
<ul>
<li>Bool: True if context limit is not exceeded, False if too many tokens</li>
<li>Number of tokens for the given messages and maximum new tokens</li>
<li>Number of tokens of 'context space left'</li>
<li>Total context token limit</li>
</ul>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>ContextExceededError</code></dt>
<dd>A ContextExceededError exception containing context usage information is raised if the
context limit is exceeded.</dd>
</dl></div>
</dd>
<dt id="clemcore.backends.utils.ensure_alternating_roles"><code class="name flex">
<span>def <span class="ident">ensure_alternating_roles</span></span>(<span>messages: List[Dict], cull_system_message: bool = True) ‑> List[Dict]</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def ensure_alternating_roles(messages: List[Dict], cull_system_message: bool = True) -&gt; List[Dict]:
    &#34;&#34;&#34;Ensure alternating chat roles by concatenating consecutive same-role messages.
    The messages format assumes alternating roles of user and assistant. This method checks if this constraint is
    satisfied. If this is not the case and there are consecutive user or assistant messages, then these are merged into
    a single message.
    Args:
        messages: List of message dicts to be checked.
        cull_system_message: Determines if empty system message(s) are removed. This assures compatibility with models
            that do not support system messages. Default: True
    Returns:
        A new messages list with alternating message roles.
    &#34;&#34;&#34;
    _messages = copy.deepcopy(messages)

    if cull_system_message:
        if _messages[0][&#39;role&#39;] == &#34;system&#34; and not _messages[0][&#34;content&#34;]:
            del _messages[0]

    def is_same_role(msg1, msg2):
        &#34;&#34;&#34;Check if two messages have the same role.
        Args:
            msg1: The first message to be checked.
            msg2: The second message to be checked.
        Returns:
            True if both messages have the same role, False otherwise.
        &#34;&#34;&#34;
        return msg1[&#34;role&#34;] == msg2[&#34;role&#34;]

    delimiter = &#34;\n\n&#34;

    def join_content(msg1, msg2):
        &#34;&#34;&#34;Join the content of two messages.
        Args:
            msg1: The first message to be checked.
            msg2: The second message to be checked.
        Returns:
            The passed messages, joined with a &#39;\n\n&#39; delimiter.
        &#34;&#34;&#34;
        return f&#34;{msg1[&#39;content&#39;]}{delimiter}{msg2[&#39;content&#39;]}&#34;

    if len(_messages) &lt;= 1:
        return _messages

    def is_valid(idx):
        &#34;&#34;&#34;Check if a message index is valid.
        Args:
            idx: The message index.
        Returns:
            True if the message index is inside the bounds of the message list.
        &#34;&#34;&#34;
        return idx &lt; len(_messages)

    msg_idx = 1
    while is_valid(msg_idx):
        prev_message = _messages[msg_idx - 1]
        message = _messages[msg_idx]
        if is_same_role(prev_message, message):
            warn_msg = (f&#34;Found consecutive role assignments. These will be merged into one:\n&#34;
                        f&#34;{prev_message}\n&#34;
                        f&#34;{message}&#34;)
            logger.warning(warn_msg)
            prev_message[&#39;content&#39;] = join_content(prev_message, message)
            del _messages[msg_idx]
        else:
            msg_idx += 1

    return _messages</code></pre>
</details>
<div class="desc"><p>Ensure alternating chat roles by concatenating consecutive same-role messages.
The messages format assumes alternating roles of user and assistant. This method checks if this constraint is
satisfied. If this is not the case and there are consecutive user or assistant messages, then these are merged into
a single message.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>messages</code></strong></dt>
<dd>List of message dicts to be checked.</dd>
<dt><strong><code>cull_system_message</code></strong></dt>
<dd>Determines if empty system message(s) are removed. This assures compatibility with models
that do not support system messages. Default: True</dd>
</dl>
<h2 id="returns">Returns</h2>
<p>A new messages list with alternating message roles.</p></div>
</dd>
<dt id="clemcore.backends.utils.ensure_messages_format"><code class="name flex">
<span>def <span class="ident">ensure_messages_format</span></span>(<span>generate_response_fn)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def ensure_messages_format(generate_response_fn):
    &#34;&#34;&#34;Wrapper function to ensure alternating message roles in backends.
    Args:
        generate_response_fn: The generate_response method of a backend class.
    Returns:
        The generate_response method of a backend class with proper alternating message roles checking.
    &#34;&#34;&#34;
    @wraps(generate_response_fn)
    def wrapped_fn(self, messages):
        _messages = ensure_alternating_roles(messages)
        return generate_response_fn(self, _messages)

    return wrapped_fn</code></pre>
</details>
<div class="desc"><p>Wrapper function to ensure alternating message roles in backends.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>generate_response_fn</code></strong></dt>
<dd>The generate_response method of a backend class.</dd>
</dl>
<h2 id="returns">Returns</h2>
<p>The generate_response method of a backend class with proper alternating message roles checking.</p></div>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="clemcore.backends" href="index.html">clemcore.backends</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="clemcore.backends.utils.check_context_limit_generic" href="#clemcore.backends.utils.check_context_limit_generic">check_context_limit_generic</a></code></li>
<li><code><a title="clemcore.backends.utils.ensure_alternating_roles" href="#clemcore.backends.utils.ensure_alternating_roles">ensure_alternating_roles</a></code></li>
<li><code><a title="clemcore.backends.utils.ensure_messages_format" href="#clemcore.backends.utils.ensure_messages_format">ensure_messages_format</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.11.6</a>.</p>
</footer>
</body>
</html>
